<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NFL Data Visualizer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #555; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], select { width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        button:hover { background-color: #0056b3; }
        #dataTable { margin-top: 20px; width: 100%; border-collapse: collapse; }
        #dataTable th, #dataTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #dataTable th { background-color: #f0f0f0; }
        #plotDiv { margin-top: 30px; }
        .error { color: red; margin-top: 10px; }
        .form-group { margin-bottom: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>NFL Data Search and Visualization</h1>

        <!-- Data Search Form -->
        <div class="form-group">
            <h2>Search NFL Data</h2>
            <label for="function_name">Select Function:</label>
            <select id="function_name" name="function_name">
                <option value="">-- Select Function --</option>
                <option value="import_pbp_data">Play-by-Play Data (import_pbp_data)</option>
                <option value="import_weekly_data">Weekly Data (import_weekly_data)</option>
                <option value="import_seasonal_data">Seasonal Data (import_seasonal_data)</option>
                <option value="import_seasonal_rosters">Seasonal Rosters (import_seasonal_rosters)</option>
                <option value="import_weekly_rosters">Weekly Rosters (import_weekly_rosters)</option>
                <option value="import_ngs_data">Next Gen Stats (import_ngs_data)</option>
                <option value="import_combine_data">Combine Data (import_combine_data)</option>
                <option value="import_draft_picks">Draft Picks (import_draft_picks)</option>
                <option value="import_qbr">QBR Data (import_qbr)</option>
                <option value="import_seasonal_pfr">Seasonal PFR Stats (import_seasonal_pfr)</option>
                <option value="import_weekly_pfr">Weekly PFR Stats (import_weekly_pfr)</option>
                <option value="import_snap_counts">Snap Counts (import_snap_counts)</option>
                <option value="import_ftn_data">FTN Charting Data (import_ftn_data)</option>
                <option value="import_depth_charts">Depth Charts (import_depth_charts)</option>
                <option value="import_injuries">Injury Reports (import_injuries)</option>
                <option value="import_schedules">Schedules (import_schedules)</option>
                <option value="import_officials">Officials (import_officials)</option>
                <option value="import_win_totals">Win Totals (import_win_totals)</option>
                <option value="import_sc_lines">Scoring Lines (import_sc_lines)</option>
                <option value="import_draft_values">Draft Values (import_draft_values)</option>
                <option value="import_team_desc">Team Descriptions (import_team_desc)</option>
                <option value="import_contracts">Contracts (import_contracts)</option>
                <option value="import_ids">Player IDs (import_ids)</option>
                <option value="import_players">All Players Data (import_players)</option>
            </select>

            <div id="common_params" class="options-group hidden">
                <label for="years">Years (comma-separated):</label>
                <input type="text" id="years" name="years" placeholder="e.g., 2022,2023">

                <label for="columns_search">Columns (comma-separated, optional):</label>
                <input type="text" id="columns_search" name="columns_search" placeholder="e.g., player_name,pass_yards">
                <button type="button" id="fetchColumnsBtn">Fetch Available Columns for PBP/Weekly</button>
                <div id="availableColumns" style="margin-top:10px;"></div>
            </div>

            <!-- Function-specific parameters -->
            <div id="params_import_pbp_data" class="specific-params options-group hidden">
                <label><input type="checkbox" name="pbp_include_participation" checked> Include Participation</label>
                <label><input type="checkbox" name="pbp_downcast" checked> Downcast Floats</label>
                <label><input type="checkbox" name="pbp_cache"> Use Cache</label>
                <label for="pbp_alt_path">Alt Cache Path:</label>
                <input type="text" name="pbp_alt_path" placeholder="Optional cache path">
                <label><input type="checkbox" name="pbp_thread_requests"> Thread Requests</label>
            </div>

            <div id="params_import_weekly_data" class="specific-params options-group hidden">
                <label><input type="checkbox" name="weekly_downcast" checked> Downcast Floats</label>
                <label><input type="checkbox" name="weekly_thread_requests"> Thread Requests</label>
            </div>

            <div id="params_import_seasonal_data" class="specific-params options-group hidden">
                <label for="seasonal_s_type">Season Type:</label>
                <select name="seasonal_s_type">
                    <option value="REG">REG</option>
                    <option value="ALL">ALL</option>
                    <option value="POST">POST</option>
                </select>
            </div>

            <div id="params_import_combine_data" class="specific-params options-group hidden">
                <label for="combine_positions">Positions (comma-separated):</label>
                <input type="text" name="combine_positions" placeholder="e.g., WR,QB">
            </div>

            <div id="params_import_ngs_data" class="specific-params options-group hidden">
                <label for="ngs_stat_type">NGS Stat Type:</label>
                <select name="ngs_stat_type">
                    <option value="passing">Passing</option>
                    <option value="rushing">Rushing</option>
                    <option value="receiving">Receiving</option>
                </select>
            </div>

            <div id="params_import_qbr" class="specific-params options-group hidden">
                <label for="qbr_level">QBR Level:</label>
                <select name="qbr_level">
                    <option value="nfl">NFL</option>
                    <option value="college">College</option>
                </select>
                <label for="qbr_frequency">QBR Frequency:</label>
                <select name="qbr_frequency">
                    <option value="season">Season</option>
                    <option value="weekly">Weekly</option>
                </select>
            </div>

            <div id="params_import_seasonal_pfr" class="specific-params options-group hidden">
                <label for="pfr_seasonal_s_type">PFR Stat Type:</label>
                <select name="pfr_seasonal_s_type">
                    <option value="pass">Pass</option>
                    <option value="rec">Rec</option>
                    <option value="rush">Rush</option>
                    <option value="def">Def</option>
                </select>
            </div>

            <div id="params_import_weekly_pfr" class="specific-params options-group hidden">
                <label for="pfr_weekly_s_type">PFR Stat Type:</label>
                <select name="pfr_weekly_s_type">
                    <option value="pass">Pass</option>
                    <option value="rec">Rec</option>
                    <option value="rush">Rush</option>
                    <option value="def">Def</option>
                </select>
            </div>

            <div id="params_import_ftn_data" class="specific-params options-group hidden">
                 <label><input type="checkbox" name="ftn_downcast" checked> Downcast Floats</label>
                 <label><input type="checkbox" name="ftn_thread_requests"> Thread Requests</label>
            </div>

            <div id="params_import_ids" class="specific-params options-group hidden">
                <label for="ids_ids">Player IDs to return (subset, comma-separated, optional):</label>
                <input type="text" name="ids_ids" placeholder="e.g., 00-0033873,00-0026498">
            </div>


            <button id="searchBtn">Search Data</button>
        </div>
        <div id="searchError" class="error"></div>

        <div id="dataDisplay" class="hidden">
            <h2>Search Results</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="dataTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Data Visualization Form -->
        <div id="visualizationForm" class="form-group hidden">
            <h2>Create Visualization</h2>
            <label for="viz_type">Visualization Type:</label>
            <select id="viz_type" name="viz_type">
                <option value="scatter">Scatter Plot</option>
                <option value="line">Line Plot</option>
                <option value="bar">Bar Chart</option>
                <option value="histogram">Histogram</option>
                <option value="box">Box Plot</option>
            </select>

            <label for="x_axis">X-Axis:</label>
            <select id="x_axis" name="x_axis"></select>

            <label for="y_axis">Y-Axis:</label>
            <select id="y_axis" name="y_axis"></select>

            <label for="color_by">Color By (Optional):</label>
            <select id="color_by" name="color_by"><option value="">None</option></select>

            <button id="visualizeBtn">Generate Visualization</button>
        </div>
        <div id="vizError" class="error"></div>
        <div id="plotDiv"></div>
    </div>

    <script>
        let currentData = null; // To store the current search result data (JSON string)
        let currentDataColumns = []; // To store column names from current search

        // Map function names to their parameter div IDs and whether they use common params
        const functionParamMap = {
            'import_pbp_data': { paramsDiv: '#params_import_pbp_data', usesCommon: true, usesYears: true, usesColumns: true, fetchableColsType: 'pbp' },
            'import_weekly_data': { paramsDiv: '#params_import_weekly_data', usesCommon: true, usesYears: true, usesColumns: true, fetchableColsType: 'weekly' },
            'import_seasonal_data': { paramsDiv: '#params_import_seasonal_data', usesCommon: true, usesYears: true, usesColumns: false }, // Columns are mostly fixed by logic
            'import_seasonal_rosters': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: true },
            'import_weekly_rosters': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: true },
            'import_ngs_data': { paramsDiv: '#params_import_ngs_data', usesCommon: true, usesYears: true, usesColumns: false }, // Columns fixed by stat_type
            'import_combine_data': { paramsDiv: '#params_import_combine_data', usesCommon: true, usesYears: true, usesColumns: false }, // Columns fixed
            'import_draft_picks': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false }, // Columns fixed
            'import_qbr': { paramsDiv: '#params_import_qbr', usesCommon: true, usesYears: true, usesColumns: false }, // Columns fixed
            'import_seasonal_pfr': { paramsDiv: '#params_import_seasonal_pfr', usesCommon: true, usesYears: true, usesColumns: false },
            'import_weekly_pfr': { paramsDiv: '#params_import_weekly_pfr', usesCommon: true, usesYears: true, usesColumns: false },
            'import_snap_counts': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false },
            'import_ftn_data': { paramsDiv: '#params_import_ftn_data', usesCommon: true, usesYears: true, usesColumns: true },
            'import_depth_charts': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false },
            'import_injuries': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false },
            'import_schedules': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false },
            // Functions generally not taking 'years' or 'columns' in the same way
            'import_officials': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false }, // years is optional
            'import_win_totals': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false }, // years is optional
            'import_sc_lines': { paramsDiv: null, usesCommon: true, usesYears: true, usesColumns: false }, // years is optional
            'import_draft_values': { paramsDiv: null, usesCommon: false }, // No years/cols
            'import_team_desc': { paramsDiv: null, usesCommon: false }, // No years/cols
            'import_contracts': { paramsDiv: null, usesCommon: false }, // No years/cols
            'import_ids': { paramsDiv: '#params_import_ids', usesCommon: true, usesYears: false, usesColumns: true }, // uses columns for subset, not years.
            'import_players': { paramsDiv: null, usesCommon: false } // No years/cols
        };

        $('#function_name').change(function() {
            const selectedFunction = $(this).val();
            $('.options-group').addClass('hidden'); // Hide all common and specific param groups
            $('#availableColumns').html('');
            $('#columns_search').val(''); // Clear columns input
            $('#years').val(''); // Clear years input


            if (selectedFunction && functionParamMap[selectedFunction]) {
                const config = functionParamMap[selectedFunction];
                if (config.usesCommon) {
                    $('#common_params').removeClass('hidden');
                    $('#years').prop('required', !!config.usesYears).closest('label').toggle(!!config.usesYears);
                    $('#columns_search').closest('label').add('#columns_search').add('#fetchColumnsBtn').add('#availableColumns').toggle(!!config.usesColumns);
                     $('#fetchColumnsBtn').toggle(!!config.fetchableColsType);
                } else {
                    // Ensure years and columns are hidden if not part of common params for this function
                     $('#years').prop('required', false).closest('label').hide();
                     $('#columns_search').closest('label').add('#columns_search').add('#fetchColumnsBtn').add('#availableColumns').hide();
                }

                if (config.paramsDiv) {
                    $(config.paramsDiv).removeClass('hidden');
                }
            } else {
                 $('#common_params').addClass('hidden'); // Hide common if no function selected or no config
            }
        });

        $('#fetchColumnsBtn').click(function() {
            const selectedFunction = $('#function_name').val();
            let fetchType = '';
            if (selectedFunction && functionParamMap[selectedFunction] && functionParamMap[selectedFunction].fetchableColsType) {
                fetchType = functionParamMap[selectedFunction].fetchableColsType;
            }

            if (!fetchType) {
                $('#availableColumns').html('<p class="error">Column fetching is only available for PBP and Weekly data types via this button.</p>');
                return;
            }
            $('#availableColumns').html('<p>Loading columns...</p>');
            $.ajax({
                url: '/get_columns', // Backend needs to handle 'fetchType' (e.g. 'pbp', 'weekly')
                type: 'GET',
                data: { data_type: fetchType }, // Changed 'data_type' to 'fetchType' for clarity if backend changes
                success: function(response) {
                    if (response.columns && response.columns.length > 0) {
                        $('#availableColumns').html('<p><strong>Available columns:</strong> ' + response.columns.join(', ') + '</p>');
                    } else {
                        $('#availableColumns').html('<p>No specific columns listed for this type, or unable to fetch. You can still try inputting columns manually.</p>');
                    }
                },
                error: function(xhr) {
                    $('#availableColumns').html('<p class="error">Error fetching columns: ' + (xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText) + '</p>');
                }
            });
        });

        $('#searchBtn').click(function() {
            $('#searchError').text('');
            $('#dataDisplay').addClass('hidden');
            $('#visualizationForm').addClass('hidden');
            $('#plotDiv').empty();
            currentData = null;
            currentDataColumns = [];

            const selectedFunction = $('#function_name').val();
            if (!selectedFunction) {
                $('#searchError').text('Please select a function first.');
                return;
            }

            let payload = {
                function_name: selectedFunction,
                // Common parameters that might be used by many functions
                years: $('#years').val() || null, // Send null if empty, backend to handle
                columns_str: $('#columns_search').val() || null,
            };

            // Add function-specific parameters from the visible form
            const config = functionParamMap[selectedFunction];
            if (config && config.paramsDiv) {
                $(`${config.paramsDiv} input, ${config.paramsDiv} select`).each(function() {
                    const input = $(this);
                    if (input.attr('type') === 'checkbox') {
                        payload[input.attr('name')] = input.is(':checked');
                    } else {
                        payload[input.attr('name')] = input.val();
                    }
                });
            }
             // Override years and columns if the function is not configured to use them from common_params
            if (config && !config.usesYears) payload.years = null;
            if (config && !config.usesColumns) payload.columns_str = null;


            $.ajax({
                url: '/search',
                type: 'POST',
                data: payload,
                success: function(response) {
                    if (response.data) {
                        // response.data is already a JSON string from df.to_json(orient='split')
                        currentData = response.data;
                        currentDataColumns = response.columns || [];

                        // For table display, parse the JSON string into an object
                        const dfObject = JSON.parse(currentData);

                        // Populate table
                        const tableHead = $('#dataTable thead');
                        const tableBody = $('#dataTable tbody');
                        tableHead.empty();
                        tableBody.empty();

                        // dfObject has 'columns' and 'data' (array of arrays)
                        if (dfObject.columns && dfObject.data && dfObject.data.length > 0) {
                            let headerRow = '<tr>';
                            dfObject.columns.forEach(col => headerRow += '<th>' + col + '</th>');
                            headerRow += '</tr>';
                            tableHead.append(headerRow);

                            dfObject.data.forEach(rowData => {
                                let row = '<tr>';
                                rowData.forEach(cell => row += '<td>' + (cell !== null ? cell : '') + '</td>'); // Handle nulls
                                row += '</tr>';
                                tableBody.append(row);
                            });
                            $('#dataDisplay').removeClass('hidden');

                            // Populate visualization dropdowns
                            populateSelectWithOptions('#x_axis', currentDataColumns);
                            populateSelectWithOptions('#y_axis', currentDataColumns);
                            populateSelectWithOptions('#color_by', currentDataColumns, true); // true for optional
                            $('#visualizationForm').removeClass('hidden');
                        } else {
                             $('#searchError').text('No data returned or data is empty.');
                        }
                    } else if (response.error) {
                        $('#searchError').text('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText;
                    $('#searchError').text('Search failed: ' + errorMsg);
                }
            });
        });

        $('#visualizeBtn').click(function() {
            $('#vizError').text('');
            $('#plotDiv').empty();

            if (!currentData) { // currentData stores the JSON string from the server
                $('#vizError').text('No data available to visualize. Please perform a search first.');
                return;
            }

            const vizPayload = {
                data_json_str: currentData, // Send the raw JSON string (already in 'split' format)
                viz_type: $('#viz_type').val(),
                x_axis: $('#x_axis').val(),
                y_axis: $('#y_axis').val(),
                color_by: $('#color_by').val()
            };

            $.ajax({
                url: '/visualize',
                type: 'POST',
                data: vizPayload,
                success: function(response) {
                    if (response.graph_json) {
                        const graphData = JSON.parse(response.graph_json);
                        Plotly.newPlot('plotDiv', graphData.data, graphData.layout);
                    } else if (response.error) {
                        $('#vizError').text('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                     const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText;
                    $('#vizError').text('Visualization failed: ' + errorMsg);
                }
            });
        });

        function populateSelectWithOptions(selectId, optionsArray, includeEmptyOption = false) {
            const selectElement = $(selectId);
            selectElement.empty();
            if (includeEmptyOption) {
                selectElement.append($('<option>', { value: '', text: 'None' }));
            }
            optionsArray.forEach(option => {
                selectElement.append($('<option>', {
                    value: option,
                    text: option
                }));
            });
        }

        // Trigger change on page load to set initial visibility of options
        $('#function_name').trigger('change');
    </script>
</body>
</html>
